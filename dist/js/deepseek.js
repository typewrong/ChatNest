(()=>{if(!window.ChatNest){console.error("ChatNest主内容脚本未加载");return}const l=(s,e)=>{let o;return function(...t){const n=this;clearTimeout(o),o=setTimeout(()=>s.apply(n,t),e)}},u=()=>{const s=[".chat-title","h1.title",".conversation-header h1",".header-title","h1","title"];for(const t of s){const n=document.querySelector(t);if(n&&n.textContent.trim())return n.textContent.trim()}const e=window.location.pathname.split("/"),o=e[e.length-1];return o?`DeepSeek对话 ${o}`:"未命名对话"},d=()=>{const s=[".message-container",".chat-message",".message-item",".conversation-message",".message"];let e=[];for(const t of s){const n=document.querySelectorAll(t);if(n&&n.length>0){e=n;break}}const o=[];return e.forEach(t=>{let n=!1;(t.classList.contains("user-message")||t.classList.contains("user")||t.classList.contains("human"))&&(n=!0),(t.getAttribute("data-role")==="user"||t.getAttribute("data-sender")==="user")&&(n=!0),t.querySelector(".user-avatar, .user-indicator, .human-avatar")&&(n=!0);const f=[".message-content",".content",".text",".message-text","p"];let r="";for(const w of f){const i=t.querySelector(w);if(i&&i.textContent.trim()){r=i.textContent.trim();break}}r||(r=t.textContent.trim()),r&&o.push({role:n?"user":"assistant",content:r})}),o},m=()=>{const s=window.ChatNest.determinePlatform(),e=window.ChatNest.getConversationIdFromUrl(),o=u(),t=d();if(t.length===0)throw new Error("未找到对话内容");return{id:e,platform:s,title:o,url:window.location.href,timestamp:Date.now(),messages:t}},a=async()=>{try{if(!await window.ChatNest.getAutoExtractEnabled()){console.log("自动提取对话功能已关闭，跳过提取");return}const e=m();await window.ChatNest.saveConversation(e),console.log("DeepSeek对话已保存:",e.title)}catch(s){console.error("保存DeepSeek对话失败:",s)}},h=l(a,1e3),g=()=>{window.ChatNest.getAutoExtractEnabled().then(s=>{if(!s){console.log("自动提取对话功能已关闭，不进行页面监听");return}const e=[".chat-container",".conversation-container",".messages-container",".conversation-messages",'[class*="chat"]','[class*="message"]',"main","#__next","body"];let o=null;for(const n of e){const c=document.querySelector(n);if(c){o=c;break}}if(!o){console.error("无法找到聊天容器");return}new MutationObserver(n=>{h()}).observe(o,{childList:!0,subtree:!0,characterData:!0}),console.log("已开始监听页面变化")})};(()=>{console.log("ChatNest DeepSeek提取器已加载"),window.ChatNest.getAutoExtractEnabled().then(e=>{console.log(`DeepSeek提取器（自动提取${e?"已启用":"已禁用"}）`)});const s=async()=>{if(!await window.ChatNest.getAutoExtractEnabled()){console.log("自动提取对话功能已关闭，不启动提取器");return}setTimeout(()=>{try{console.log("立即尝试保存对话..."),a()}catch(o){console.warn("初次保存失败，可能页面尚未完全加载",o)}setTimeout(()=>{console.log("再次尝试保存对话..."),a(),g()},3e3)},1e3)};document.readyState==="complete"?s():window.addEventListener("load",s)})()})();
