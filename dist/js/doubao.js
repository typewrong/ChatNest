(()=>{if(!window.ChatNest){console.error("ChatNest主内容脚本未加载");return}const d=(s,o)=>{let t;return function(...e){const n=this;clearTimeout(t),t=setTimeout(()=>s.apply(n,e),o)}},h=()=>{const s=[".conversation-title",".chat-title",".session-title","h1.title",".header-title","h1","title"];for(const e of s){const n=document.querySelector(e);if(n&&n.textContent.trim())return n.textContent.trim()}const o=window.location.pathname.split("/"),t=o[o.length-1];return t?`豆包对话 ${t}`:"未命名对话"},f=()=>{try{console.log("开始提取豆包对话内容...");const s=document.querySelectorAll('.container-EC68Od.container-jPfT9u, [class*="container-EC68Od"][class*="container-jPfT9u"]'),o=document.querySelectorAll('.container-ZYIsnH.flow-markdown-body, [class*="container-ZYIsnH"][class*="flow-markdown-body"]');if(console.log("找到用户消息容器数量:",s.length),console.log("找到AI助手消息容器数量:",o.length),s.length===0&&o.length===0){const n=[".message-box-xy4dB8s",'[class*="message-box"]',".message-item",".chat-message",".message-container"];for(const c of n){const a=document.querySelectorAll(c);if(a.length>0)return console.log(`使用备用选择器 ${c} 找到 ${a.length} 个元素`),x(a)}console.log("当前页面主要DOM结构:");const r=document.querySelector('.chat-container, [class*="chat"], main, #app');throw console.log(r?r.outerHTML.substring(0,500)+"...":"No chat container found"),new Error("未找到对话内容")}const t=u(s,!0),e=u(o,!1);return b(t,e)}catch(s){throw console.error("提取豆包对话内容时出错:",s),s}},u=(s,o)=>{const t=[];return s.forEach((e,n)=>{console.log(`提取${o?"用户":"AI"}消息 #${n+1}，容器:`,e);let r;o?r=e.querySelector('.message-content, [class*="message-content"], [class*="message-box-content"]'):r=e;let c="";if(r?o?(c=r.textContent.trim(),console.log("提取到的用户消息内容:",c)):(console.log("开始提取AI格式化文本，容器内容预览:",r.innerHTML.substring(0,200)+"..."),c=E(r),console.log("提取到的AI回复内容:",c.substring(0,200)+(c.length>200?"...":""))):c=e.textContent.trim(),c){const a=w(e);t.push({role:o?"user":"assistant",content:c,position:a})}}),t},E=s=>{console.log("开始提取格式化文本，元素类型:",s.nodeName);const o=(e,n=[])=>{if(e.nodeType===Node.TEXT_NODE){const r=e.textContent.trim();r&&n.push(r)}else if(e.nodeType===Node.ELEMENT_NODE){const r=["P","DIV","LI","H1","H2","H3","H4","H5","H6","BLOCKQUOTE"].includes(e.nodeName),c=e.nodeName==="BR";for(const a of e.childNodes)o(a,n);(r||c)&&n.push("")}return n};try{const e=o(s);if(console.log("从文本节点提取的段落数量:",e.length),e.length>0){const n=e.join(`
`).replace(/\n{3,}/g,`

`).trim();return console.log("方法1提取结果(前100字符):",n.substring(0,100)+"..."),n}}catch(e){console.error("提取所有文本节点时出错:",e)}try{const e=s.querySelectorAll("p, div, li, h1, h2, h3, h4, h5, h6, blockquote, span, strong, em, b, i, a, code, pre");if(e.length>0){console.log("找到段落元素数量:",e.length);let n="";e.forEach(c=>{const a=c.textContent.trim();a&&(n+=a+`

`)});const r=n.trim();return console.log("方法2提取结果(前100字符):",r.substring(0,100)+"..."),r}}catch(e){console.error("提取段落元素时出错:",e)}const t=s.textContent.trim();return console.log("方法3提取结果(前100字符):",t.substring(0,100)+"..."),t},w=s=>{let o=0,t=s;for(;t;)t.previousElementSibling?(t=t.previousElementSibling,o++):t=t.parentElement;return o},b=(s,o)=>{const t=[...s,...o];return t.sort((e,n)=>e.position-n.position),t.map(e=>{const{position:n,...r}=e;return r})},x=s=>{const o=[];return s.forEach(t=>{let e=!1;(t.classList.contains("user-message")||t.classList.contains("user")||t.classList.contains("human")||t.classList.contains("question")||t.classList.toString().includes("reverse"))&&(e=!0),(t.getAttribute("data-role")==="user"||t.getAttribute("data-sender")==="user"||t.getAttribute("data-type")==="question")&&(e=!0),t.querySelector(".user-avatar, .user-indicator, .human-avatar, .question-indicator")&&(e=!0);const r=[".message-content",'[class*="message-content"]',".content",".text",".message-text",".markdown-body","p"];let c="";for(const a of r){const i=t.querySelector(a);if(i&&i.textContent.trim()){c=i.textContent.trim();break}}c||(c=t.textContent.trim()),c&&o.push({role:e?"user":"assistant",content:c})}),o},g=()=>{const s=window.ChatNest.determinePlatform(),o=window.ChatNest.getConversationIdFromUrl(),t=h(),e=f();if(e.length===0)throw new Error("未找到对话内容");return{id:o,platform:s,title:t,url:window.location.href,timestamp:Date.now(),messages:e}},l=async()=>{try{if(!await window.ChatNest.getAutoExtractEnabled()){console.log("自动提取对话功能已关闭，跳过提取");return}if(!window.ChatNest.isExtensionValid()){console.error("扩展上下文已失效，无法保存对话");try{const t=g(),e=`chatnest_temp_${t.id}`;chrome.storage.local.set({[e]:t},()=>{if(chrome.runtime.lastError){console.error("使用chrome.storage.local保存失败:",chrome.runtime.lastError);return}console.log("已将对话临时保存到chrome.storage.local:",e)})}catch(t){console.error("临时保存失败:",t)}return}const o=g();console.log(`准备保存对话 (${o.messages.length} 条消息):`,o.messages.map(t=>({role:t.role,contentPreview:t.content.substring(0,30)})));try{await window.ChatNest.saveConversation(o),console.log("豆包对话已保存:",o.title)}catch(t){const e=t instanceof Error?t.message:typeof t=="string"?t:"未知错误";if(console.error("保存豆包对话失败:",e),e.includes("Extension context invalidated")||e.includes("扩展上下文已失效")){console.error("扩展上下文已失效，尝试使用备用方法保存");try{const n=`chatnest_temp_${o.id}`;chrome.storage.local.set({[n]:o},()=>{if(chrome.runtime.lastError){console.error("使用chrome.storage.local保存失败:",chrome.runtime.lastError);return}console.log("已将对话临时保存到chrome.storage.local:",n)})}catch(n){console.error("临时保存也失败:",n)}}}}catch(s){const o=s instanceof Error?s.message:typeof s=="string"?s:"未知错误";console.error("保存对话过程中出错:",o)}},m=d(l,1e3),p=()=>{window.ChatNest.getAutoExtractEnabled().then(s=>{if(!s){console.log("自动提取对话功能已关闭，不进行页面监听");return}const o=[".chat-container",'[class*="container-EC68Od"]','[class*="container-ZYIsnH"]','[class*="message-box"]','[class*="chat"]','[class*="message"]','[class*="conversation"]',"main","#app","body"];let t=null;for(const n of o){const r=document.querySelector(n);if(r){t=r,console.log(`使用选择器 "${n}" 找到聊天容器`);break}}t||(console.error("无法找到聊天容器，将监听整个文档"),t=document),new MutationObserver(n=>{n.some(c=>Array.from(c.addedNodes).some(a=>a.nodeType===Node.ELEMENT_NODE?a.classList&&(a.classList.contains("container-EC68Od")||a.classList.contains("container-jPfT9u")||a.classList.contains("container-ZYIsnH")||a.classList.contains("flow-markdown-body")||a.classList.contains("message-box-xy4dB8s")||a.querySelector(".container-EC68Od, .container-jPfT9u, .container-ZYIsnH, .flow-markdown-body, .message-box-xy4dB8s")):!1))?(console.log("检测到页面变化，可能有新消息"),m()):setTimeout(()=>m(),5e3)}).observe(t,{childList:!0,subtree:!0,characterData:!0,attributes:!0}),console.log("已开始监听页面变化"),setInterval(()=>{console.log("定期保存对话..."),l()},3e4)})};(()=>{console.log("ChatNest 豆包提取器已加载"),console.log("当前页面URL:",window.location.href),console.log("豆包对话ID:",window.ChatNest.getConversationIdFromUrl()),window.ChatNest.getAutoExtractEnabled().then(o=>{console.log(`豆包提取器已加载（自动提取${o?"已启用":"已禁用"}）`)});const s=async()=>{if(!await window.ChatNest.getAutoExtractEnabled()){console.log("自动提取对话功能已关闭，不启动提取器");return}setTimeout(()=>{try{console.log("立即尝试保存对话..."),l()}catch(t){console.warn("初次保存失败，可能页面尚未完全加载",t)}setTimeout(()=>{console.log("再次尝试保存对话..."),l(),p()},3e3)},1e3)};window.addEventListener("load",s),(document.readyState==="complete"||document.readyState==="interactive")&&(console.log("页面已加载，立即开始提取..."),s())})()})();
