let y={conversations:[],platform:"all",keyword:""};const h=e=>{const o=document.getElementById("progress-value"),r=document.getElementById("status");o.style.width=`${e}%`,e===0?r.textContent="准备导出...":e<100?r.textContent=`正在导出... ${e}%`:r.textContent="导出完成"},$=(e,o,r)=>{try{const t=new Blob([r],{type:"text/markdown"}),n=`${o.replace(/[<>:"/\\|?*]/g,"_")}_${e.substring(0,8)}.md`;return chrome.downloads.download({url:URL.createObjectURL(t),filename:`ChatNest/${n}`,saveAs:!1},l=>{chrome.runtime.lastError&&(console.error("导出失败:",chrome.runtime.lastError),alert(`导出失败: ${chrome.runtime.lastError.message}`))}),{success:!0}}catch(t){return console.error("导出过程中发生错误:",t),{success:!1,error:t}}},p=async e=>{try{if(typeof JSZip>"u")return alert("需要JSZip库来批量导出！请确保已经加载。"),{success:!1,error:new Error("JSZip库未加载")};const o=new JSZip,r=o.folder("ChatNest");let t=0;const n=e.length;for(const i of e)try{const c=await new Promise((m,E)=>{chrome.runtime.sendMessage({action:"getConversation",id:i.id},g=>{chrome.runtime.lastError?E(chrome.runtime.lastError):g.error?E(new Error(g.error)):m(g.conversation)})}),f=await new Promise((m,E)=>{chrome.runtime.sendMessage({action:"conversationToMarkdown",conversation:c},g=>{chrome.runtime.lastError?E(chrome.runtime.lastError):m(g.markdown)})}),d=`${c.title.replace(/[<>:"/\\|?*]/g,"_")}_${c.id.substring(0,8)}.md`;r.file(d,f),t++;const u=Math.round(t/n*100);h(u)}catch(c){console.error(`处理对话 ${i.id} 时出错:`,c)}const l=await o.generateAsync({type:"blob"}),s=new Date().toISOString().replace(/[:.]/g,"-").substring(0,19);return chrome.downloads.download({url:URL.createObjectURL(l),filename:`ChatNest_Export_${s}.zip`,saveAs:!0},i=>{chrome.runtime.lastError&&(console.error("ZIP导出失败:",chrome.runtime.lastError),alert(`ZIP导出失败: ${chrome.runtime.lastError.message}`))}),{success:!0}}catch(o){return console.error("批量导出过程中发生错误:",o),h(0),alert(`批量导出失败: ${o.message}`),{success:!1,error:o}}},v=async e=>{try{if(e.length===0){alert("没有可导出的对话！");return}if(e.length>1&&confirm(`您选择了 ${e.length} 个对话，是否批量导出为ZIP文件？

点击"确定"进行批量导出
点击"取消"将分别导出每个对话`))return p(e);h(0);let o=0;const r=e.length,t=[];for(const l of e)try{const s=await new Promise((d,u)=>{chrome.runtime.sendMessage({action:"getConversation",id:l.id},m=>{chrome.runtime.lastError?u(chrome.runtime.lastError):m.error?u(new Error(m.error)):d(m.conversation)})}),i=await new Promise((d,u)=>{chrome.runtime.sendMessage({action:"conversationToMarkdown",conversation:s},m=>{chrome.runtime.lastError?u(chrome.runtime.lastError):d(m.markdown)})}),c=$(s.id,s.title||"未命名对话",i);t.push(c),o++;const f=Math.round(o/r*100);h(f)}catch(s){console.error(`处理对话 ${l.id} 时出错:`,s),t.push({success:!1,error:s})}const n=t.filter(l=>l.success).length;return alert(n===r?`全部 ${r} 个对话导出成功！`:`${n} 个对话导出成功，${r-n} 个失败。
请查看控制台了解详细错误信息。`),{success:n>0,totalSuccess:n,totalFailed:r-n}}catch(o){return console.error("导出全部对话时发生错误:",o),h(0),alert(`导出失败: ${o.message}`),{success:!1,error:o}}},w=e=>{const o=document.getElementById("export-list");if(o.innerHTML="",e.length===0){o.innerHTML='<div class="empty-list">没有符合条件的对话</div>';return}const r={};e.forEach(t=>{r[t.platform]||(r[t.platform]=[]),r[t.platform].push(t)});for(const t in r){const n=document.createElement("div");n.className="platform-title",n.textContent=t,o.appendChild(n),r[t].forEach(s=>{const i=document.createElement("div");i.className="export-item";const c=document.createElement("div");c.className="title",c.textContent=s.title||"未命名对话";const f=document.createElement("div");f.className="time",f.textContent=new Date(s.timestamp).toLocaleString(),i.appendChild(c),i.appendChild(f),i.addEventListener("click",()=>{chrome.runtime.sendMessage({action:"getConversation",id:s.id},d=>{if(chrome.runtime.lastError){console.error("获取对话失败:",chrome.runtime.lastError),alert(`获取对话失败: ${chrome.runtime.lastError.message}`);return}if(d.error){console.error("获取对话失败:",d.error),alert(`获取对话失败: ${d.error}`);return}chrome.runtime.sendMessage({action:"conversationToMarkdown",conversation:d.conversation},u=>{$(s.id,s.title||"未命名对话",u.markdown)})})}),o.appendChild(i)})}},C=async()=>{try{a("开始获取对话列表");const{platform:e,keyword:o}=y;a(`获取参数：平台=${e}, 关键词=${o}`);const r=document.getElementById("status-message");r&&(r.textContent="正在加载对话内容..."),document.getElementById("export-list").innerHTML='<div class="loading">加载中...</div>',chrome.runtime.sendMessage({action:e==="all"?"getAllConversations":"getConversationsByPlatform",platform:e},t=>{if(chrome.runtime.lastError){const s=chrome.runtime.lastError.message;a(`获取对话列表失败: ${s}`,!0),document.getElementById("export-list").innerHTML=`<div class="error">获取对话列表失败: ${s}</div>`,r&&(r.textContent="加载失败，请返回重试");return}if(a(`收到后台响应: ${JSON.stringify(t)}`),!t||t.error){const s=t?t.error:"未收到有效响应";a(`获取对话列表失败: ${s}`,!0),document.getElementById("export-list").innerHTML=`<div class="error">获取对话列表失败: ${s}</div>`,r&&(r.textContent="加载失败，请返回重试");return}let n=[];t.conversations?n=t.conversations:t.data?n=t.data:Array.isArray(t)&&(n=t),a(`解析对话数据成功，共 ${n.length} 个对话`);let l=n;if(o){const s=o.toLowerCase();l=l.filter(i=>i.title&&i.title.toLowerCase().includes(s)||i.summary&&i.summary.toLowerCase().includes(s)),a(`关键词过滤后剩余 ${l.length} 个对话`)}y.conversations=l,r&&(l.length>0?r.textContent=`找到 ${l.length} 个对话`:r.textContent="没有找到匹配的对话"),w(l)})}catch(e){a(`获取对话列表时发生错误: ${e.message}`,!0),document.getElementById("export-list").innerHTML=`<div class="error">获取对话列表失败: ${e.message}</div>`;const o=document.getElementById("status-message");o&&(o.textContent="发生错误，请返回重试")}};function a(e,o=!1){if(console.log(`[导出页面] ${e}`),!document.getElementById("debug-info")){const n=document.createElement("div");n.id="debug-info",n.innerHTML='<h3>调试信息</h3><div id="debug-content"></div>',document.body.appendChild(n)}document.getElementById("debug-info").style.display="block";const r=document.getElementById("debug-content"),t=document.createElement("p");t.textContent=`${new Date().toLocaleTimeString()}: ${e}`,o&&(t.style.color="#e74c3c"),r.appendChild(t),r.scrollTop=r.scrollHeight}chrome.runtime.onMessage.addListener((e,o,r)=>{var t,n;if(a(`全局收到消息: ${JSON.stringify(e)}`),e.type==="EXPORT_CONVERSATIONS")return a(`全局收到导出请求，对话数: ${((n=(t=e.data)==null?void 0:t.conversations)==null?void 0:n.length)||0}`),e.data&&e.data.conversations?(y=e.data,w(y.conversations),r({success:!0})):(a("收到的导出数据无效",!0),r({success:!1,error:"无效数据"})),!0});document.addEventListener("DOMContentLoaded",async()=>{try{console.log("导出页面初始化..."),a("开始加载导出数据...");const e=await C();a(`成功加载 ${e.length} 个对话`),initPlatformFilter(e),initKeywordFilter(e);const o=document.getElementById("export-all");o&&o.addEventListener("click",()=>{a("开始批量导出所有对话...");const r=e.filter(t=>!(currentPlatform!=="all"&&t.platform!==currentPlatform||currentKeyword&&!t.title.toLowerCase().includes(currentKeyword.toLowerCase())));if(r.length===0){a("没有符合条件的对话可导出",!0),alert("没有符合条件的对话可导出");return}a(`准备导出 ${r.length} 个对话`),v(r)}),updateStatus(`已加载 ${e.length} 个对话，可以开始导出`),w(e),a("导出页面初始化完成")}catch(e){console.error("初始化导出页面失败:",e),a(`初始化导出页面失败: ${e.message}`,!0),updateStatus(`加载失败: ${e.message}`,!0)}});
